name: Sam CI/CD Pipeline

on:
  push:
    branches:
      - staging     
  create:
    tags:
      - '*'         

jobs:

  # staging
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # Create .env for staging
    - name: Create .env for staging
      run: |
        echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env

    # Zip the project
    - name: Zip project
      run: zip -r app.zip . -x "*.git*"

    # Setup SSH key
    - name: Setup SSH key for staging
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.STAGING_EC2_KEY }}" > ~/.ssh/staging_key.pem
        chmod 600 ~/.ssh/staging_key.pem

    # Upload code to EC2
    - name: Upload to staging EC2
      run: |
        scp -o StrictHostKeyChecking=no -i ~/.ssh/staging_key.pem app.zip \
        ubuntu@${{ secrets.STAGING_EC2_HOST }}:/home/ubuntu/app.zip

    # Deploy and run Flask
    - name: Deploy on staging EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/staging_key.pem ubuntu@${{ secrets.STAGING_EC2_HOST }} '
          sudo apt update -y
          sudo apt install unzip python3-venv python3-pip -y

          sudo rm -rf /home/ubuntu/app
          sudo mkdir -p /home/ubuntu/app
          sudo unzip -o /home/ubuntu/app.zip -d /home/ubuntu/app

          cd /home/ubuntu/app
          python3 -m venv venv
          /home/ubuntu/app/venv/bin/pip install --upgrade pip
          /home/ubuntu/app/venv/bin/pip install flask==2.3.2 flask-pymongo==2.3.0 pymongo==3.13.1 python-dotenv==1.0.0

          echo "[Unit]
          Description=Flask App
          After=network.target

          [Service]
          User=ubuntu
          WorkingDirectory=/home/ubuntu/app
          EnvironmentFile=/home/ubuntu/app/.env
          ExecStart=/home/ubuntu/app/venv/bin/python /home/ubuntu/app/app.py

          Restart=always

          [Install]
          WantedBy=multi-user.target" | sudo tee /etc/systemd/system/flaskapp.service

          sudo systemctl daemon-reload
          sudo systemctl enable flaskapp
          sudo systemctl restart flaskapp
        '

  # prod
  deploy-production:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # Create .env for production
    - name: Create .env for production
      run: |
        echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env

    - name: Zip project
      run: zip -r app.zip . -x "*.git*"

    - name: Setup SSH key for production
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PROD_EC2_KEY }}" > ~/.ssh/prod_key.pem
        chmod 600 ~/.ssh/prod_key.pem

    - name: Upload to production EC2
      run: |
        scp -o StrictHostKeyChecking=no -i ~/.ssh/prod_key.pem app.zip \
        ubuntu@${{ secrets.PROD_EC2_HOST }}:/home/ubuntu/app.zip

    - name: Deploy on production EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/prod_key.pem ubuntu@${{ secrets.PROD_EC2_HOST }} '
          sudo apt update -y
          sudo apt install unzip python3-venv python3-pip -y

          sudo rm -rf /home/ubuntu/app
          sudo mkdir -p /home/ubuntu/app
          sudo unzip -o /home/ubuntu/app.zip -d /home/ubuntu/app

          cd /home/ubuntu/app
          python3 -m venv venv
          /home/ubuntu/app/venv/bin/pip install --upgrade pip
          /home/ubuntu/app/venv/bin/pip install flask==2.3.2 flask-pymongo==2.3.0 pymongo==3.13.1 python-dotenv==1.0.0

          echo "[Unit]
          Description=Flask App
          After=network.target

          [Service]
          User=ubuntu
          WorkingDirectory=/home/ubuntu/app
          EnvironmentFile=/home/ubuntu/app/.env
          ExecStart=/home/ubuntu/app/venv/bin/python /home/ubuntu/app/app.py

          Restart=always

          [Install]
          WantedBy=multi-user.target" | sudo tee /etc/systemd/system/flaskapp.service

          sudo systemctl daemon-reload
          sudo systemctl enable flaskapp
          sudo systemctl restart flaskapp
        '
